{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect | Connections</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="{% static 'form.css' %}">
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <link rel="stylesheet" href="{% static 'chat.css' %}">

    

</head>
<body>
    <nav>
        <h2>Connect</h2>
    </nav>

    <div class="container">
        <h3 style="text-align: center;">Connection Page</h3>
        <div class="profile-div">
           <p>Connected with : {{connected_user.first_name}}</p>
           {% if connected_user.gender %}
           <p>Gender : {{connected_user.gender}}</p>
           {% endif %}
           
           {% if connected_user.country %}
           <p>Country : {{connected_user.country}}</p>
           {% endif %}
        </div>
        <input type="hidden" id="room_id" value="{{room_id}}">
        <input type="hidden" id="user" value="{{request.user.first_name}}">

        <div id="messages">
            
        </div>

        <form action="" id="message-form">
            <input class="msg-inp" type="text" placeholder="Type message and press enter....." name="message">
        </form>

       
       
    </div>

    <!-- Script for Websocket connection -->

    <script type="text/javascript">
        let room_id = document.getElementById('room_id').value
        let user = document.getElementById('user').value
        let url = `ws://${window.location.host}/ws/socket-server/${room_id}`
        
        const chatsocket = new WebSocket(url)

        chatsocket.onmessage = function(e) {
            let data = JSON.parse(e.data)
            console.log('Data:',data)

            if(data.type === 'chat'){
                let messages = document.getElementById('messages')

                messages.insertAdjacentHTML('beforeend',`<div class='chat-msg'>
                    <img src='https://www.nicepng.com/png/full/128-1280406_view-user-icon-png-user-circle-icon-png.png' class='msg-profile' alt='message-profile-pic'/>
                    <div>
                        <p class='msg-user'>${data.username}</p>
                        <p>${data.message}</p>
                    </div>
                    </div>`)
            }
            var container = document.querySelector('#messages');
            container.scrollTop = container.scrollHeight;
        }

        let form = document.getElementById('message-form')

        form.addEventListener('submit', (e)=> {
            e.preventDefault()
            let message = e.target.message.value
            chatsocket.send(JSON.stringify({
                'message':message,
                'username':user
            }))
            form.reset()
        })

        // Get the scrollable container element
    </script>


    <!-- Script ends -->
    
</body>
</html>